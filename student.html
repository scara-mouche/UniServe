<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UNISERVE PORTAL</title>
  <link rel="stylesheet" href="student.css" /><!DOCTYPE html>
<html lang="en">
<body>
  <header>
    <nav class="navbar">
  <ul class="nav-links">
    <li><a href="student.html">Home</a></li>
    <li><a href="AboutUs.html">About Us</a></li>
    <li><a href="Contact.html">Contact Us</a></li>
    <li><a href="studentprofile.html">My Account</a></li>
    <li><a href="index.html">Logout</a></li>
  </ul>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search uniforms...">
    <button>üîç</button>
  </div>
</nav>
    <div class="container">
      <h1>üè´ EARIST UniServe Portal</h1>
      <button id="cart-toggle">üõí Cart (<span id="cart-count">0</span>)</button>
    </div>


  </header>
  <main class="container">
    <h2 class="section-title">Available Uniforms</h2>
    <div class="product-grid">

<div class="product-card" data-name="Institutional Top Uniform (Male)" data-base-price="950" data-stock="5">
  <img src="M Insti Top.jpg" alt="uni">
  <h3 class="product-name">Institutional Top Uniform (Male)</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±800</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Pants Uniform (Male)" data-base-price="950" data-stock="5">
  <img src="M Insti Pants.jpg" alt="uni">
  <h3 class="product-name">Institutional Pants Uniform (Male)</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±800</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Uniform (Male)" data-base-price="950" data-stock="5">
  <img src="M Insti Set.jpg" alt="uni">
  <h3 class="product-name">Institutional Uniform Set (Male)</h3>
  <p class="price-display">Price: ‚Ç±1200 - ‚Ç±1350</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Uniform (Female)" data-base-price="950" data-stock="5">
  <img src="F Insti Top.jpg" alt="uni">
  <h3 class="product-name">Institutional Top Uniform (Female)</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±800</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Uniform (Female)" data-base-price="950" data-stock="5">
  <img src="F Insti Pants.jpg" alt="uni">
  <h3 class="product-name">Institutional Pants Uniform (Female)</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±800</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Uniform (Female)" data-base-price="950" data-stock="5">
  <img src="F Insti Skirt.jpg" alt="uni">
  <h3 class="product-name">Institutional Skirt Uniform (Female)</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±800</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Uniform (Female)" data-base-price="950" data-stock="5">
  <img src="F Insti Set.jpg" alt="uni">
  <h3 class="product-name">Institutional Uniform Pants Set (Female)</h3>
  <p class="price-display">Price: ‚Ç±1200 - ‚Ç±1350</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="Institutional Uniform (Female)" data-base-price="950" data-stock="5">
  <img src="F Insti Skirt Set.jpg" alt="uni">
  <h3 class="product-name">Institutional Skirt Set Uniform (Female)</h3>
  <p class="price-display">Price: ‚Ç±1200 - ‚Ç±1350</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="PE Uniform" data-base-price="950" data-stock="5">
  <img src="Pant.jpg" alt="uni">
  <h3 class="product-name">PE Uniform Pants</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±700</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="PE Uniform" data-base-price="950" data-stock="5">
  <img src="1st PE Top.jpg" alt="uni">
  <h3 class="product-name">PE 1st Year Top Uniform</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±700</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="PE Uniform" data-base-price="950" data-stock="5">
  <img src="1st PE Set.jpg" alt="uni">
  <h3 class="product-name">PE 1st Year Set Uniform</h3>
  <p class="price-display">Price: ‚Ç±1200 - ‚Ç±1050</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="PE Uniform" data-base-price="950" data-stock="5">
  <img src="2nd PE Top.jpg" alt="uni">
  <h3 class="product-name">PE 2nd Year Top Uniform</h3>
  <p class="price-display">Price: ‚Ç±650 - ‚Ç±700</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>

<div class="product-card" data-name="PE Uniform" data-base-price="950" data-stock="5">
  <img src="PE Set (2nd Year).jpg" alt="uni">
  <h3 class="product-name">PE 2nd Year Set Uniform</h3>
  <p class="price-display">Price: ‚Ç±1200 - ‚Ç±1050</p>
  <p class="stock-display"><span class="stock-count"></span></p>
</div>
  </main>
  <!-- CART SIDEBAR -->
   <!-- Checkout Modal -->
<div id="checkout-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-checkout">&times;</span>
    <h2>Checkout Form</h2>
    <form id="checkout-form">
      <label>Student Name:
        <input type="text" name="studentName" required>
      </label><br>
      <label>Student ID:
        <input type="text" name="studentId" required>
      </label><br>
      <label for="payment">Payment Method</label>
<input type="text" name="payment" value="GCash" readonly>
<br>
      <label>Delivery Instructions:
        <textarea name="instructions" rows="3"></textarea>
      </label><br>
      <button type="submit">Confirm Order</button>
    </form>
  </div>
</div>
  <div id="cart-sidebar">
    <h2>Your Cart</h2>
    <ul id="cart-items"></ul>
    <p class="total">Total: ‚Ç±<span id="cart-total">0</span></p>
    <button id="checkout">Checkout</button>
    <button id="close-cart" class="back-btn">‚¨Ö Back to Shop</button>
  </div>

  <footer>
    <p>¬© 2025 EARIST UniServe Portal ‚Ä¢ Department Exclusive</p>
  </footer>

<script>
const productStocks = {
  "Institutional Top Uniform (Male)": {
    "Small": { price: 650, stock: 20 },
    "Medium": { price: 650, stock: 34 },
    "Large": { price: 700, stock: 7 },
    "XL": { price: 700, stock: 15 },
    "2XL / 3XL": { price: 750, stock: 4 },
    "4XL / 5XL": { price: 800, stock: 3 }
  },
  "Institutional Pants Uniform (Male)": {
    "Small": { price: 650, stock: 3 },
    "Medium": { price: 650, stock: 9 },
    "Large": { price: 700, stock: 2 },
    "XL": { price: 700, stock: 1 },
    "2XL / 3XL": { price: 750, stock: 22 },
    "4XL / 5XL": { price: 800, stock: 1 }
  },
  "Institutional Uniform Set (Male)": {
    "Small": { price: 1200, stock: 5 },
    "Medium": { price: 1200, stock: 2 },
    "Large": { price: 1250, stock: 3 },
    "XL": { price: 1250, stock: 3 },
    "2XL / 3XL": { price: 1300, stock: 1 },
    "4XL / 5XL": { price: 1350, stock: 8 }
  },
  "Institutional Top Uniform (Female)": {
    "Small": { price: 650, stock: 4 },
    "Medium": { price: 650, stock: 3 },
    "Large": { price: 700, stock: 2 },
    "XL": { price: 700, stock: 6 },
    "2XL / 3XL": { price: 750, stock: 8 },
    "4XL / 5XL": { price: 800, stock: 9 }
  },
  "Institutional Pants Uniform (Female)": {
    "Small": { price: 650, stock: 3 },
    "Medium": { price: 650, stock: 1 },
    "Large": { price: 700, stock: 2 },
    "XL": { price: 700, stock: 5 },
    "2XL / 3XL": { price: 750, stock: 54 },
    "4XL / 5XL": { price: 800, stock: 1 }
  },
  "Institutional Uniform Pants Set (Female)": {
    "Small": { price: 1200, stock: 5 },
    "Medium": { price: 1200, stock: 3 },
    "Large": { price: 1250, stock: 2 },
    "XL": { price: 1250, stock: 1 },
    "2XL / 3XL": { price: 1300, stock: 8 },
    "4XL / 5XL": { price: 1350, stock: 9 }
  },
  "Institutional Skirt Set Uniform (Female)": {
    "Small": { price: 1200, stock: 4 },
    "Medium": { price: 1200, stock: 2 },
    "Large": { price: 1250, stock: 1 },
    "XL": { price: 1250, stock: 0 },
    "2XL / 3XL": { price: 1300, stock: 9 },
    "4XL / 5XL": { price: 1350, stock: 7 }
  },
  "Institutional Skirt Uniform (Female)": {
    "Small": { price: 650, stock: 3 },
    "Medium": { price: 650, stock: 1 },
    "Large": { price: 700, stock: 8 },
    "XL": { price: 700, stock: 6 },
    "2XL / 3XL": { price: 750, stock: 5 },
    "4XL / 5XL": { price: 800, stock: 7 }
  },
  "PE Uniform Pants": {
    "Small": { price: 650, stock: 5 },
    "Medium": { price: 650, stock: 3 },
    "Large": { price: 700, stock: 2 },
    "XL": { price: 700, stock: 7 }
  },
  "PE 1st Year Top Uniform": {
    "Small": { price: 650, stock: 4 },
    "Medium": { price: 650, stock: 2 },
    "Large": { price: 700, stock: 9 },
    "XL": { price: 700, stock: 8 }
  },
  "PE 1st Year Set Uniform": {
    "Small": { price: 1000, stock: 3 },
    "Medium": { price: 1000, stock: 1 },
    "Large": { price: 1050, stock: 7 },
    "XL": { price: 1050, stock: 6 }
  },
  "PE 2nd Year Top Uniform": {
    "Small": { price: 650, stock: 2 },
    "Medium": { price: 650, stock: 2 },
    "Large": { price: 700, stock: 1 },
    "XL": { price: 700, stock: 6 }
  },
  "PE 2nd Year Set Uniform": {
    "Small": { price: 1000, stock: 5 },
    "Medium": { price: 1000, stock: 4 },
    "Large": { price: 1050, stock: 2 },
    "XL": { price: 1050, stock: 5 }
  }
};
// Sample cart data

const checkoutBtn = document.getElementById('checkout');
const checkoutModal = document.getElementById('checkout-modal');
const closeCheckout = document.querySelector('.close-checkout');
const checkoutForm = document.getElementById('checkout-form');

const generateReceiptID = () => "RCPT-" + Math.floor(Math.random() * 1000000);
const formatDate = (d) => d.toLocaleDateString('en-PH');

checkoutBtn.addEventListener('click', () => {
  if (cart.length === 0) {
    alert("üõí Your cart is empty.");
  } else {
    checkoutModal.style.display = 'flex';
  }
});

closeCheckout.addEventListener('click', () => {
  checkoutModal.style.display = 'none';
});

checkoutForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const formData = new FormData(checkoutForm);
  const name = formData.get('studentName');
  const id = formData.get('studentId');
  const notes = formData.get('instructions');
  const receiptID = generateReceiptID();
  const now = new Date();
  const pickup = new Date(); pickup.setDate(now.getDate() + 3);
  const payment = "GCash";
  const status = "Processing";

  const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);

  let receipt = `üßæ ORDER RECEIPT\n`;
  receipt += `Receipt ID: ${receiptID}\n`;
  receipt += `üë§ Name: ${name}\nüÜî ID: ${id}\nüí∞ Payment: ${payment}\n`;
  receipt += `Checkout: ${formatDate(now)}\nPickup: ${formatDate(pickup)}\n\nItems:\n`;

  cart.forEach(item => {
    // ‚úÖ Update stock here only on checkout
    const stockInfo = productStocks[item.name][item.size];
    stockInfo.stock -= item.qty;

    receipt += `‚Ä¢ ${item.name} (${item.size}) x${item.qty} = ‚Ç±${item.price * item.qty}\n`;
  });

  receipt += `\nTotal: ‚Ç±${total}\nNote: ${notes}`;
  alert(receipt);

  
  // ‚úÖ Hide modal early
  checkoutModal.style.display = 'none';

  // üî• Save order to Firebase
  firebase.firestore().collection("checkouts").add({
    studentId: id,
    studentName: name,
    receiptId: receiptID,
    paymentMethod: payment,
    instructions: notes,
    date: firebase.firestore.Timestamp.fromDate(now),
    pickupDate: firebase.firestore.Timestamp.fromDate(pickup),
    status: status,
    total: total,
    items: cart.map(item => ({
      name: item.name,
      size: item.size,
      qty: item.qty,
      price: item.price
    }))
  }).then(() => {
    cart = [];
    updateCart();
    checkoutForm.reset();

    // ‚úÖ Show full receipt before redirect
    alert(receipt);

    setTimeout(() => {
      window.location.href = `feedback.html?receiptId=${receiptID}`;
    }, 100);
  }).catch((error) => {
    console.error("Checkout error:", error);
    alert("‚ùå Something went wrong. Please try again.");
  });
});

</script>

  <script>
document.getElementById('searchInput').addEventListener('input', function () {
  const input = this.value.toLowerCase();
  const products = document.querySelectorAll('.product-card');
  products.forEach(card => {
    const name = card.querySelector('.product-name').textContent.toLowerCase();
    if (name.includes(input)) {
      card.style.visibility = 'visible';
      card.style.position = 'static';
      card.style.opacity = '1';
      card.style.pointerEvents = 'auto';
    } else {
      card.style.visibility = 'hidden';
      card.style.position = 'absolute';
      card.style.opacity = '0';
      card.style.pointerEvents = 'none';
    }
  });
});
</script>
<div id="product-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <img id="modal-image" src="" alt="Product Image">
    <h3 id="modal-name">Product Name</h3>
    <label>Size:
      <select id="modal-size"></select>
    </label>
    <p id="modal-price">Price: ‚Ç±</p>
    <label>Quantity:
      <input type="number" id="modal-qty" min="1" value="1">
    </label>
    <div class="modal-buttons">
      <button id="modal-add-to-cart">Add to Cart</button>
      <button id="modal-purchase">Buy Now</button>
    </div>
  </div>
</div>

<script>
  document.getElementById("modal-purchase").addEventListener('click', () => {
    const name = modalName.textContent;
    const size = modalSize.value;
    const price = Number(modalSize.options[modalSize.selectedIndex].dataset.price);
    const qty = Number(modalQty.value);

    if (!size || qty <= 0) {
      alert("‚ùå Please select size and quantity.");
      return;
    }

    const sizeStock = productStocks[name][size];
    if (qty > sizeStock.stock) {
      alert("‚ùå Not enough stock.");
      return;
    }

    // ‚úÖ Add the product to cart
    cart = [{ name, size, price, qty }]; // overwrite cart with 1 item
    updateCart();

    // ‚úÖ Open checkout modal
    checkoutModal.style.display = "flex";

    // ‚úÖ Close the product modal
    modal.style.display = "none";
  });
</script>

<script>
const modal = document.getElementById("product-modal");
const modalImage = document.getElementById("modal-image");
const modalName = document.getElementById("modal-name");
const modalSize = document.getElementById("modal-size");
const modalPrice = document.getElementById("modal-price");
const modalQty = document.getElementById("modal-qty");
const closeBtn = document.querySelector(".close-button");
let currentProductCard = null;
// Open modal when a product card is clicked
document.querySelectorAll('.product-card').forEach(card => {
  card.addEventListener('click', (e) => {
    // Prevent opening when clicking buttons inside the card
    if (e.target.tagName === "BUTTON" || e.target.tagName === "SELECT" || e.target.tagName === "INPUT") return;
    currentProductCard = card;
    const imgSrc = card.querySelector('img').src;
    const name = card.querySelector('.product-name').textContent;
    const sizeSelect = card.querySelector('.size-select');
    const selectedPrice = sizeSelect.options[sizeSelect.selectedIndex].value;
    // Fill modal
    modalImage.src = imgSrc;
    modalName.textContent = name;
    modalSize.innerHTML = sizeSelect.innerHTML; // Copy size options
    modalPrice.textContent = `Price: ‚Ç±${selectedPrice}`;
    modalQty.value = 1;
    modal.style.display = "flex";
  });
});
// Close modal
closeBtn.onclick = () => {
  modal.style.display = "none";
};
// Update price on modal size change
modalSize.addEventListener('change', () => {
  modalPrice.textContent = `Price: ‚Ç±${modalSize.value}`;
});
// Add to cart from modal
document.getElementById("modal-add-to-cart").addEventListener('click', () => {
  const name = modalName.textContent;
  const size = modalSize.value;
  const price = Number(modalSize.options[modalSize.selectedIndex].dataset.price);
  const qty = Number(modalQty.value);

  if (qty <= 0) return;

  const sizeStock = productStocks[name][size];
  if (qty > sizeStock.stock) {
    alert("Not enough stock.");
    return;
  }

  // Add to cart
  cart.push({ name, size, price, qty });
  updateCart();

  // Update stock

  const option = [...modalSize.options].find(o => o.value === size);
  option.textContent = `${size} (${sizeStock.stock} left) - ‚Ç±${price}`;
  if (sizeStock.stock <= 0) {
    option.disabled = true;
    modalSize.selectedIndex = [...modalSize.options].findIndex(o => !o.disabled);
    if (modalSize.selectedIndex >= 0) {
      const newOption = modalSize.options[modalSize.selectedIndex];
      modalPrice.textContent = `Price: ‚Ç±${newOption.dataset.price}`;
    } else {
      modalPrice.textContent = 'Out of Stock';
      document.getElementById("modal-add-to-cart").disabled = true;
    }
  }
  modal.style.display = "none";
});


</script>

<script>
// ------------------------
// CART FUNCTIONALITY
// ------------------------
let cart = [];
const cartItemsContainer = document.getElementById('cart-items');
const cartTotal = document.getElementById('cart-total');
const cartCount = document.getElementById('cart-count');
function updateCart() {
  cartItemsContainer.innerHTML = '';
  let total = 0;
  cart.forEach((item, index) => {
    const li = document.createElement('li');
    li.classList.add('cart-item');
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    li.style.marginBottom = '10px';
    const itemText = document.createElement('span');
    itemText.textContent = `${item.name} (${item.size}) x${item.qty} ‚Äî ‚Ç±${item.price * item.qty}`;
    const removeBtn = document.createElement('button');
    removeBtn.classList.add('remove-btn');
    removeBtn.dataset.index = index;
    removeBtn.textContent = '‚ùå';
    removeBtn.style.marginLeft = '10px';
    removeBtn.style.background = 'none';
    removeBtn.style.border = 'none';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.color = 'red';
    li.appendChild(itemText);
    li.appendChild(removeBtn);
    cartItemsContainer.appendChild(li);
    total += item.price * item.qty;
  });
  cartTotal.textContent = total;
  cartCount.textContent = cart.length;
}
// üîÅ Remove button functionality
cartItemsContainer.addEventListener('click', function (e) {
  if (e.target.classList.contains('remove-btn')) {
    const index = parseInt(e.target.dataset.index);
    if (!isNaN(index)) {
      cart.splice(index, 1);
      updateCart();
    }
  }
});
// -------------------------
// ADD TO CART PER PRODUCT
// -------------------------

document.querySelectorAll('.product-card').forEach(card => {
  card.addEventListener('click', () => {
    const name = card.querySelector('.product-name').textContent;
    modalName.textContent = name;
    modalImage.src = card.querySelector('img').src;
    modalQty.value = 1;

    const sizeData = productStocks[name];
    modalSize.innerHTML = '';

    for (const [size, info] of Object.entries(sizeData)) {
      const option = document.createElement('option');
      option.textContent = `${size} (${info.stock} left) - ‚Ç±${info.price}`;
      option.value = size;
      option.dataset.price = info.price;
      option.disabled = info.stock === 0;
      modalSize.appendChild(option);
    }

    const firstAvailable = [...modalSize.options].find(opt => !opt.disabled);
    if (firstAvailable) {
      modalSize.value = firstAvailable.value;
      modalPrice.textContent = `Price: ‚Ç±${firstAvailable.dataset.price}`;
      document.getElementById("modal-add-to-cart").disabled = false;
    } else {
      modalPrice.textContent = 'Out of Stock';
      document.getElementById("modal-add-to-cart").disabled = true;
    }

    modal.style.display = "flex";
  });
});

// -----------------------------
// CART SIDEBAR TOGGLE BUTTON
// -----------------------------
const cartSidebar = document.getElementById('cart-sidebar');
const cartToggle = document.getElementById('cart-toggle');
const closeCartBtn = document.getElementById('close-cart');
cartToggle.addEventListener('click', () => {
  cartSidebar.classList.toggle('open');
});
closeCartBtn.addEventListener('click', () => {
  cartSidebar.classList.remove('open');
});

modalSize.addEventListener('change', () => {
  const selectedOption = modalSize.options[modalSize.selectedIndex];
  modalPrice.textContent = `Price: ‚Ç±${selectedOption.dataset.price}`;
});

</script>

<script type="module">
  // ‚úÖ Import Firebase Modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  // ‚úÖ Your Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyCmY01W7nrK_SnKCGM4sblWna03KbLDEwU",
    authDomain: "uniserve-d990a.firebaseapp.com",
    projectId: "uniserve-d990a",
    storageBucket: "uniserve-d990a.appspot.com",
    messagingSenderId: "417274438534",
    appId: "1:417274438534:web:c7ff020cd9d8d19fd30207"
  };

  // ‚úÖ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  // ‚úÖ Autofill User Info
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const uid = user.uid;
      const userDoc = await getDoc(doc(db, "users", uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        document.querySelector('input[name="studentName"]').value = data.name || "";
        document.querySelector('input[name="studentId"]').value = data.student_id || "";
      }
    }
  });

  // ‚úÖ Update Cart View
  function updateCart() {
    cartItemsContainer.innerHTML = '';
    let total = 0;
    cart.forEach((item, index) => {
      const li = document.createElement('li');
      li.innerHTML = `${item.name} (${item.size}) x${item.qty} ‚Äî ‚Ç±${item.price * item.qty} 
        <button class="remove-btn" data-index="${index}" style="color:red;">‚ùå</button>`;
      cartItemsContainer.appendChild(li);
      total += item.price * item.qty;
    });
    cartTotal.textContent = total;
    cartCount.textContent = cart.length;
  }

  // ‚úÖ Remove Item from Cart
  cartItemsContainer.addEventListener('click', function (e) {
    if (e.target.classList.contains('remove-btn')) {
      const index = parseInt(e.target.dataset.index);
      if (!isNaN(index)) {
        cart.splice(index, 1);
        updateCart();
      }
    }
  });

  // ‚úÖ Checkout Submit Handler
  checkoutForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(checkoutForm);
    const name = formData.get('studentName');
    const id = formData.get('studentId');
    const notes = formData.get('instructions');
    const receiptID = generateReceiptID();
    const now = new Date();
    const pickup = new Date();
    pickup.setDate(now.getDate() + 3);
    const payment = "GCash";
    const status = "Processing";

    const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);

    let receipt = `üßæ ORDER RECEIPT\nReceipt ID: ${receiptID}\nüë§ Name: ${name}\nüÜî ID: ${id}\nüí∞ Payment: ${payment}\n`;
    receipt += `Checkout: ${formatDate(now)}\nPickup: ${formatDate(pickup)}\n\nItems:\n`;

    cart.forEach(item => {
      if (productStocks[item.name]?.[item.size]) {
        productStocks[item.name][item.size].stock -= item.qty;
      }
      receipt += `‚Ä¢ ${item.name} (${item.size}) x${item.qty} = ‚Ç±${item.price * item.qty}\n`;
    });

    receipt += `\nTotal: ‚Ç±${total}\nNote: ${notes}`;

    try {
      await addDoc(collection(db, "checkouts"), {
        studentId: id,
        studentName: name,
        receiptId: receiptID,
        paymentMethod: payment,
        instructions: notes,
        date: Timestamp.fromDate(now),
        pickupDate: Timestamp.fromDate(pickup),
        status: status,
        total: total,
        items: cart.map(item => ({
          name: item.name,
          size: item.size,
          qty: item.qty,
          price: item.price
        }))
      });

      // ‚úÖ Clear cart and reset UI
      cart = [];
      updateCart();
      checkoutForm.reset();
      checkoutModal.style.display = 'none';

      alert(receipt);
      setTimeout(() => {
        window.location.href = `feedback.html?receiptId=${receiptID}`;
      }, 300);
    } catch (error) {
      console.error("‚ùå Firestore error:", error);
      alert("‚ùå Something went wrong while saving your order.");
    }
  });

  // ‚úÖ Optional: expose cart globally (if needed in other scripts)
  window.cart = cart;
  window.updateCart = updateCart;
</script>

</body>
</html>
